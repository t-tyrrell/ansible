---
- name: Bootstrap RHEL Server
  hosts: all
  become: true
  vars_files:
    - ../group_vars/bootstrap.yml
    - ../group_vars/bootstrap_vault.yml

  vars_prompt:
    - name: satellite_activation_key
      prompt: "Select Satellite activation key:\n  1) rhel8-nonprod\n  2) rhel8-prod\n  3) rhel9-nonprod\nEnter choice (1-3)"
      private: false
      default: "1"

  tasks:
    - name: Set activation key based on selection
      ansible.builtin.set_fact:
        satellite_activation_key: "{{ activation_key_map[satellite_activation_key] }}"
      vars:
        activation_key_map:
          "1": "rhel8-nonprod"
          "2": "rhel8-prod"
          "3": "rhel9-nonprod"
          "rhel8-nonprod": "rhel8-nonprod"
          "rhel8-prod": "rhel8-prod"
          "rhel9-nonprod": "rhel9-nonprod"
      tags: always

    - name: Display selected activation key
      ansible.builtin.debug:
        msg: "Using activation key: {{ satellite_activation_key }}"
      tags: always

    # ============================================
    # 1. Set Hostname
    # ============================================
    - name: Set system hostname
      ansible.builtin.hostname:
        name: "{{ bootstrap_hostname }}"
      when: bootstrap_hostname is defined
      tags: hostname

    - name: Update /etc/hosts with hostname
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1 {{ bootstrap_hostname }}.{{ domain_name }} {{ bootstrap_hostname }}"
        state: present
      when: bootstrap_hostname is defined
      tags: hostname

    # ============================================
    # 2. Join Active Directory using realm
    # ============================================
    - name: Install required packages for AD join
      ansible.builtin.dnf:
        name:
          - realmd
          - sssd
          - oddjob
          - oddjob-mkhomedir
          - adcli
          - samba-common
          - samba-common-tools
          - krb5-workstation
          - python3-pexpect
        state: present
      tags: ad_join

    - name: Check if system is already joined to AD
      ansible.builtin.command:
        cmd: realm list
      register: realm_list
      changed_when: false
      failed_when: false
      tags: ad_join

    - name: Join system to Active Directory
      ansible.builtin.expect:
        command: "realm join --user={{ ad_join_user }} {{ ad_domain }} --computer-ou='{{ ad_computer_ou }}'"
        responses:
          (?i)password: "{{ ad_join_password }}"
      when:
        - realm_list.stdout == ""
        - ad_join_user is defined
        - ad_join_password is defined
      no_log: true
      tags: ad_join

    # ============================================
    # 3. Configure realm access control
    # ============================================
    - name: Configure SSSD to use simple access provider
      ansible.builtin.lineinfile:
        path: /etc/sssd/sssd.conf
        regexp: '^access_provider'
        line: 'access_provider = simple'
        state: present
      notify: restart sssd
      tags: ad_access

    - name: Deny all users by default
      ansible.builtin.command:
        cmd: realm deny --all
      changed_when: false
      tags: ad_access

    - name: Permit specific AD groups
      ansible.builtin.command:
        cmd: "realm permit -g '{{ item }}'"
      loop: "{{ ad_permitted_groups }}"
      when: ad_permitted_groups is defined
      changed_when: false
      tags: ad_access

    - name: Configure automatic home directory creation
      ansible.builtin.lineinfile:
        path: /etc/sssd/sssd.conf
        regexp: '^{{ item.key }}'
        line: '{{ item.key }} = {{ item.value }}'
        state: present
      loop:
        - { key: 'fallback_homedir', value: '/home/%u' }
        - { key: 'default_shell', value: '/bin/bash' }
      notify: restart sssd
      tags: ad_access

    - name: Enable oddjobd service for home directory creation
      ansible.builtin.service:
        name: oddjobd
        state: started
        enabled: true
      tags: ad_access

    - name: Create sudoers drop-in file for g_linux group
      ansible.builtin.copy:
        content: "g_linux@northshore.local ALL=(ALL) NOPASSWD:ALL\n"
        dest: /etc/sudoers.d/g_linux
        owner: root
        group: root
        mode: '0440'
        validate: /usr/sbin/visudo -cf %s
      tags: sudoers

    # ============================================
    # 4. Register with Red Hat Satellite
    # ============================================
    - name: Check if system is registered with Satellite
      ansible.builtin.command:
        cmd: subscription-manager status
      register: subscription_status
      changed_when: false
      failed_when: false
      tags: satellite

    - name: Install Satellite CA certificate
      ansible.builtin.dnf:
        name: "http://{{ satellite_hostname }}/pub/katello-ca-consumer-latest.noarch.rpm"
        state: present
        disable_gpg_check: true
      when: subscription_status.rc != 0
      tags: satellite

    - name: Register with Satellite using activation key
      community.general.redhat_subscription:
        state: present
        activationkey: "{{ satellite_activation_key }}"
        org_id: "{{ satellite_organization }}"
      when: subscription_status.rc != 0
      tags: satellite

    - name: Enable Satellite remote execution
      ansible.builtin.dnf:
        name: katello-host-tools
        state: present
      tags: satellite

    # ============================================
    # 5. Run system updates
    # ============================================
    - name: Update all packages
      ansible.builtin.dnf:
        name: "*"
        state: latest
        update_cache: true
      register: system_update
      tags: updates

    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required
      tags: updates

    - name: Display update results
      ansible.builtin.debug:
        msg: "System updated. Reboot may be required for kernel updates."
      when: system_update.changed
      tags: updates

    # ============================================
    # 6. Install CrowdStrike Falcon
    # ============================================
    - name: Check if CrowdStrike is already installed
      ansible.builtin.command:
        cmd: /opt/CrowdStrike/falconctl -g --cid
      register: falcon_check
      changed_when: false
      failed_when: false
      tags: crowdstrike

    - name: Download CrowdStrike Falcon sensor
      ansible.builtin.get_url:
        url: "{{ crowdstrike_sensor_url }}"
        dest: "/tmp/{{ crowdstrike_sensor_package }}"
        mode: '0644'
      when:
        - falcon_check.rc != 0
        - crowdstrike_sensor_url is defined
      tags: crowdstrike

    - name: Install CrowdStrike Falcon sensor
      ansible.builtin.dnf:
        name: "/tmp/{{ crowdstrike_sensor_package }}"
        state: present
        disable_gpg_check: "{{ crowdstrike_disable_gpg_check | default(false) }}"
      when:
        - falcon_check.rc != 0
        - crowdstrike_sensor_url is defined
      tags: crowdstrike

    - name: Configure CrowdStrike with Customer ID
      ansible.builtin.command:
        cmd: "/opt/CrowdStrike/falconctl -s --cid={{ crowdstrike_cid }}"
      when:
        - falcon_check.rc != 0
        - crowdstrike_cid is defined
      no_log: true
      tags: crowdstrike

    - name: Start and enable CrowdStrike Falcon service
      ansible.builtin.service:
        name: falcon-sensor
        state: started
        enabled: true
      when:
        - falcon_check.rc != 0
        - crowdstrike_cid is defined
      tags: crowdstrike

    - name: Remove CrowdStrike installer
      ansible.builtin.file:
        path: "/tmp/{{ crowdstrike_sensor_package }}"
        state: absent
      tags: crowdstrike

    # ============================================
    # 7. Remove root SSH access
    # ============================================
    - name: Disable root SSH login
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin no'
        state: present
        validate: /usr/sbin/sshd -t -f %s
      notify: restart sshd
      tags: ssh


    # ============================================
    # 8. Configure firewall rules
    # ============================================
    - name: Ensure firewalld service is running and enabled
      ansible.builtin.service:
        name: firewalld
        state: started
        enabled: true
      tags: firewall

    - name: Allow ICMP from all
      ansible.posix.firewalld:
        protocol: icmp
        zone: public
        state: enabled
        permanent: true
        immediate: true
      tags: firewall

    - name: Configure SSH rich rules for authorized networks
      ansible.posix.firewalld:
        rich_rule: 'rule family="ipv4" source address="{{ item.source }}" service name="ssh" accept'
        zone: public
        state: enabled
        permanent: true
        immediate: true
      loop: "{{ firewall_ssh_allowed_sources }}"
      when: firewall_ssh_allowed_sources is defined
      tags: firewall

    - name: Remove SSH as a service from public zone
      ansible.posix.firewalld:
        service: ssh
        zone: public
        state: disabled
        permanent: true
        immediate: true
      when: firewall_disable_default_ssh | default(true)
      tags: firewall

    - name: Configure additional firewall services
      ansible.posix.firewalld:
        service: "{{ item.service }}"
        zone: "{{ item.zone | default('public') }}"
        state: "{{ item.state | default('enabled') }}"
        permanent: true
        immediate: true
      loop: "{{ firewall_additional_services }}"
      when: firewall_additional_services is defined
      tags: firewall

    - name: Configure additional firewall ports
      ansible.posix.firewalld:
        port: "{{ item.port }}/{{ item.protocol | default('tcp') }}"
        zone: "{{ item.zone | default('public') }}"
        state: "{{ item.state | default('enabled') }}"
        permanent: true
        immediate: true
      loop: "{{ firewall_additional_ports }}"
      when: firewall_additional_ports is defined
      tags: firewall

    - name: Reload firewalld
      ansible.builtin.command:
        cmd: firewall-cmd --reload
      changed_when: false
      tags: firewall

    - name: List all firewall rules
      ansible.builtin.command:
        cmd: firewall-cmd --list-all
      register: firewall_rules
      changed_when: false
      tags: firewall

    - name: Display firewall rules
      ansible.builtin.debug:
        var: firewall_rules.stdout_lines
      tags: firewall

  # ============================================
  # Handlers
  # ============================================
  handlers:
    - name: restart sssd
      ansible.builtin.service:
        name: sssd
        state: restarted

    - name: restart sshd
      ansible.builtin.service:
        name: sshd
        state: restarted
