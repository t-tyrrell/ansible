---
- name: Bootstrap RHEL Server
  hosts: all
  become: true
  vars_files:
    - ../group_vars/bootstrap.yml
    - ../group_vars/bootstrap_vault.yml

  vars_prompt:
    - name: satellite_activation_key
      prompt: "Select Satellite activation key:\n  1) rhel8-nonprod\n  2) rhel8-prod\n  3) rhel9-nonprod\nEnter choice (1-3)"
      private: false
      default: "1"

  tasks:
    - name: Set activation key based on selection
      ansible.builtin.set_fact:
        satellite_activation_key: "{{ activation_key_map[satellite_activation_key] }}"
      vars:
        activation_key_map:
          "1": "rhel8-nonprod"
          "2": "rhel8-prod"
          "3": "rhel9-nonprod"
          "rhel8-nonprod": "rhel8-nonprod"
          "rhel8-prod": "rhel8-prod"
          "rhel9-nonprod": "rhel9-nonprod"
      tags: always

    - name: Display selected activation key
      ansible.builtin.debug:
        msg: "Using activation key: {{ satellite_activation_key }}"
      tags: always

  roles:
    - role: hostname
      tags: hostname

    - role: ad_join
      tags: [ad_join, ad_access, sudoers]

    - role: satellite_registration
      tags: satellite

    - role: system_updates
      tags: updates

    - role: crowdstrike
      tags: crowdstrike

    - role: ssh_hardening
      tags: ssh

    - role: firewall
      tags: firewall
