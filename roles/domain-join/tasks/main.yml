---
# ============================================
# DOMAIN-JOIN ROLE - TASKS
# ============================================
# Purpose: Join server to Active Directory domain
# ============================================

- name: Install required packages for realm
  yum:
    name:
      - realmd
      - sssd
      - oddjob
      - oddjob-mkhomedir
      - adcli
      - samba-common
      - samba-common-tools
      - krb5-workstation
    state: present

- name: Check if system is already joined to domain
  command: realm list
  register: realm_check
  changed_when: false
  failed_when: false

- name: Display current domain status
  debug:
    msg: "{{ 'System is already joined to a domain' if realm_check.rc == 0 and realm_check.stdout != '' else 'System is not joined to a domain' }}"

- name: Domain join block
  when: realm_check.rc != 0 or realm_check.stdout == '' or not ad_skip_if_joined
  block:
    - name: Discover AD domain
      command: "realm discover {{ ad_domain }}"
      register: realm_discover
      changed_when: false

    - name: Display discovered domain info
      debug:
        msg: "Domain discovered: {{ ad_domain }}"
      when: realm_discover.rc == 0

    - name: Join system to AD domain
      command: >
        realm join {{ ad_domain }}
        --user={{ ad_join_username }}
        --computer-ou=""
      environment:
        REALM_PASSWORD: "{{ ad_join_password }}"
      register: realm_join_result
      no_log: true

    - name: Verify domain join
      command: realm list
      register: verify_realm
      changed_when: false

    - name: Display domain join success
      debug:
        msg: "✓ Successfully joined to domain: {{ ad_domain }}"
      when: verify_realm.rc == 0 and verify_realm.stdout != ''

  rescue:
    - name: Domain join failed
      fail:
        msg: "Failed to join domain {{ ad_domain }}. Check credentials and connectivity."

- name: Configure allowed groups for login
  command: "realm permit -g {{ item }}"
  loop: "{{ ad_allowed_groups }}"
  register: permit_groups

- name: Enable automatic home directory creation
  service:
    name: oddjobd
    state: started
    enabled: yes
  when: ad_create_homedir | bool

- name: Display allowed groups
  debug:
    msg: "✓ Domain access configured for groups: {{ ad_allowed_groups | join(', ') }}"
