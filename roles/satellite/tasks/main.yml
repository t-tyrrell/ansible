---
# ============================================
# SATELLITE ROLE - TASKS
# ============================================
# Purpose: Register server to Red Hat Satellite
# ============================================

- name: Check if system is already registered to Satellite
  command: subscription-manager identity
  register: subscription_check
  failed_when: false
  changed_when: false

- name: Display current registration status
  debug:
    msg: "System is already registered to Satellite"
  when: subscription_check.rc == 0

- name: Satellite registration block
  when: subscription_check.rc != 0 or not satellite_skip_if_registered
  block:
    - name: Detect OS version
      set_fact:
        os_major_version: "{{ ansible_distribution_major_version }}"

    - name: Detect environment (prod vs non-prod)
      set_fact:
        is_production: "{{ 'all-prod' in group_names }}"

    - name: Set activation key based on OS version and environment
      set_fact:
        activation_key: >-
          {% if os_major_version == '9' and is_production %}
          {{ satellite_activation_key_rhel9_prod }}
          {% elif os_major_version == '9' and not is_production %}
          {{ satellite_activation_key_rhel9_nonprod }}
          {% elif os_major_version == '8' and is_production %}
          {{ satellite_activation_key_rhel8_prod }}
          {% else %}
          {{ satellite_activation_key_rhel8_nonprod }}
          {% endif %}

    - name: Display registration details
      debug:
        msg:
          - "Registering to Satellite: {{ satellite_server }}"
          - "Organization: {{ satellite_organization }}"
          - "Activation Key: {{ activation_key | trim }}"
          - "OS Version: RHEL {{ os_major_version }}"
          - "Environment: {{ 'Production' if is_production else 'Non-Production' }}"

    - name: Unregister from any existing subscriptions
      command: subscription-manager unregister
      failed_when: false
      changed_when: false

    - name: Clean subscription-manager data
      command: subscription-manager clean
      changed_when: false

    - name: Remove old katello-ca-consumer package (if exists)
      yum:
        name: katello-ca-consumer-*
        state: absent
      failed_when: false

    - name: Install katello-ca-consumer package
      yum:
        name: "http://{{ satellite_server }}/pub/katello-ca-consumer-latest.noarch.rpm"
        state: present
        disable_gpg_check: yes

    - name: Register to Satellite with activation key using subscription-manager
      shell: >
        subscription-manager register
        --org="{{ satellite_organization }}"
        --activationkey="{{ activation_key | trim }}"
        --force
      register: registration_result
      changed_when: "'The system has been registered' in registration_result.stdout"

    - name: Verify registration
      command: subscription-manager identity
      register: verify_registration
      changed_when: false

    - name: Display registration success
      debug:
        msg: "âœ“ Successfully registered to Satellite: {{ satellite_server }}"
      when: verify_registration.rc == 0

    - name: Display subscription status
      command: subscription-manager status
      register: subscription_status
      changed_when: false
      failed_when: false

    - name: Show subscription status
      debug:
        var: subscription_status.stdout_lines

  rescue:
    - name: Registration failed
      fail:
        msg: "Failed to register to Satellite. Check activation keys and connectivity."
