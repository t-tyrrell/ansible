---
# tasks file for crowdstrike role
- name: Check if CrowdStrike is already installed
  ansible.builtin.command:
    cmd: /opt/CrowdStrike/falconctl -g --cid
  register: falcon_check
  changed_when: false
  failed_when: false
  tags: crowdstrike

- name: Download CrowdStrike Falcon sensor
  ansible.builtin.get_url:
    url: "{{ crowdstrike_sensor_url }}"
    dest: "/tmp/{{ crowdstrike_sensor_package }}"
    mode: '0644'
  when:
    - falcon_check.rc != 0
    - crowdstrike_sensor_url is defined
  tags: crowdstrike

- name: Install CrowdStrike Falcon sensor
  ansible.builtin.dnf:
    name: "/tmp/{{ crowdstrike_sensor_package }}"
    state: present
    disable_gpg_check: "{{ crowdstrike_disable_gpg_check | default(false) }}"
  when:
    - falcon_check.rc != 0
    - crowdstrike_sensor_url is defined
  tags: crowdstrike

- name: Configure CrowdStrike with Customer ID
  ansible.builtin.command:
    cmd: "/opt/CrowdStrike/falconctl -s --cid={{ crowdstrike_cid }}"
  when:
    - falcon_check.rc != 0
    - crowdstrike_cid is defined
  no_log: true
  tags: crowdstrike

- name: Start and enable CrowdStrike Falcon service
  ansible.builtin.service:
    name: falcon-sensor
    state: started
    enabled: true
  when:
    - falcon_check.rc != 0
    - crowdstrike_cid is defined
  tags: crowdstrike

- name: Remove CrowdStrike installer
  ansible.builtin.file:
    path: "/tmp/{{ crowdstrike_sensor_package }}"
    state: absent
  tags: crowdstrike
